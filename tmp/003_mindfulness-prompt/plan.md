# 実装計画: Gemini APIプロンプトのマインドフルネス型への改善

## 目的

日替わりメッセージ生成のプロンプトを、より心に響く「マインドフルネス型」に改善し、読者に深い癒しを提供する。

## 現状分析

### 現在のプロンプト（シンプル型）

```
あなたは詩人です。今日は${dateStr}です。
この日付に関連した、心温まるメッセージを日本語で1つ書いてください。
以下の条件を守ってください：
- 200文字以内
- 指定された季節に合った内容にする（他の季節の話は絶対にしない）
- 優しく前向きな内容
- です・ます調
- メッセージのみを出力（説明や前置きは不要）
```

**課題**:
- 表現が一般的で個性が弱い
- 五感への訴求が不足
- 「今、ここ」への意識付けが弱い
- マインドフルネスの要素がない

## 実装スコープ

### 1. プロンプトの改善

**ファイル**: `functions/api/daily-message.ts`（97-105行目）

**新しいプロンプト（マインドフルネス型）**:

```typescript
const prompt = `あなたはマインドフルネスの実践者であり詩人です。今日は${dateStr}です。

「今、ここ」に意識を向け、${dateStr}のこの瞬間の美しさを感じるメッセージを書いてください。

【条件】
- 200文字以内
- ${dateStr}の「今この瞬間」に存在する季節の要素を描く
- 呼吸、五感、身体感覚に意識を向ける表現
- 過去や未来ではなく「今」に集中させる
- 静けさ、穏やかさを感じさせる
- です・ます調
- メッセージのみを出力（説明や前置きは不要）

【表現例】
- 「深く息を吸うと、〇〇の香りが...」
- 「足元の〇〇に目を向けると...」
- 「今日の空は...」`;
```

## 改善のポイント

### 1. マインドフルネスの核心を組み込む

- **「今、ここ」への集中**: 過去・未来への意識を減らし、現在に集中
- **呼吸への意識**: 深呼吸から始まる身体感覚
- **五感の活性化**: 視覚・聴覚・触覚・嗅覚への訴求

### 2. 具体的な表現例を提示

プロンプトに具体例を含めることで、AIの生成品質が向上:
- 「深く息を吸うと、〇〇の香りが...」
- 「足元の〇〇に目を向けると...」
- 「今日の空は...」

### 3. 静けさと穏やかさの重視

- 焦燥感を煽る表現を避ける
- 静寂を大切にする
- 心を落ち着かせる言葉選び

## 期待される効果

### メッセージの質的向上

**従来のメッセージ例**:
> 白い息が踊る12月31日（水曜日）、冬は、厚手のマフラーのように優しさで身を包む日です。

**マインドフルネス型のメッセージ例**:
> 深く息を吸い込むと、12月31日、水曜日の澄んだ冬の空気が胸に満ちます。頬を撫でる冷たさ、足元の枯れ葉の静かな佇まい。遠くの音も、この穏やかな静寂に溶け込んでゆきます。ただ「今、ここ」に意識を集中

**改善点**:
- 呼吸から始まる身体感覚 ✓
- 五感への訴求（触覚・視覚・聴覚） ✓
- 「今、ここ」への明示的な誘導 ✓
- より深い静けさと穏やかさ ✓

## 技術的詳細

### 変更箇所

- **ファイル**: `functions/api/daily-message.ts`
- **関数**: `generateDailyMessage()`
- **行数**: 97-105行目（プロンプト定義部分）

### 影響範囲

- **フロントエンド**: 変更なし
- **API仕様**: 変更なし
- **レスポンス形式**: 変更なし
- **キャッシュ機構**: 変更なし

### 既存機能への影響

**影響なし**:
- メッセージ長（200文字以内）は維持
- 季節感の考慮は維持
- です・ます調は維持
- Gemini APIの呼び出し方法は変更なし

## テスト計画

### 1. ビルドテスト

```bash
npm run build
```

- TypeScriptコンパイルエラーがないこと
- ビルドが正常に完了すること

### 2. デプロイ後の動作確認

```bash
# キャッシュクリア
npx wrangler kv key delete --binding=DAILY_MESSAGE_CACHE --namespace-id=xxx "2025-12-31" --remote

# API呼び出し
curl -s https://biotope.pages.dev/api/daily-message | python3 -m json.tool
```

**確認項目**:
- [ ] `source: "gemini"` が返される（fallbackでない）
- [ ] メッセージが途中で切れていない
- [ ] マインドフルネス的な表現が含まれている
- [ ] 呼吸・五感への言及がある
- [ ] 「今、ここ」への意識付けがある

### 3. 品質確認

生成されたメッセージを複数回確認:

```bash
# 複数回キャッシュクリアして確認
for i in {1..3}; do
  npx wrangler kv key delete ... --remote
  sleep 3
  curl -s https://biotope.pages.dev/api/daily-message
  echo "---"
done
```

**評価基準**:
- マインドフルネス要素の一貫性
- 五感への訴求の多様性
- メッセージの深さ・質

## 想定される課題と対策

### 課題1: プロンプトが長すぎてトークン消費増加

**対策**:
- 現状の`maxOutputTokens: 2000`で対応可能
- 必要に応じてプロンプトを簡潔化

### 課題2: AIが表現例に固執しすぎる

**対策**:
- 「表現例」として明示し、バリエーションを促す
- 必要に応じて例を削除または変更

### 課題3: 季節感が薄れる

**対策**:
- 「${dateStr}の季節要素」を強調する表現を追加
- テストで季節感を確認

## 完了条件

- [x] プロンプトをマインドフルネス型に変更
- [x] `npm run build` が成功
- [x] デプロイ完了
- [x] 生成メッセージにマインドフルネス要素が含まれる
- [x] 五感への訴求がある
- [x] 「今、ここ」への意識付けがある

## 実装時間見積もり

- プロンプト変更: 5分
- ビルド・デプロイ: 5分
- 動作確認: 5分
- **合計**: 約15分

---

**次のステップ**: すでに実装済み（事後記録）
