# Biotope ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

Reactã€TypeScriptã€Three.jsã‚’ä½¿ç”¨ã—ãŸãƒ“ã‚ªãƒˆãƒ¼ãƒ—ç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

ğŸŒ **Live Demo**: https://biotope.pages.dev/

## ä¸»ãªæ©Ÿèƒ½

- **3Dãƒ“ã‚ªãƒˆãƒ¼ãƒ—ç’°å¢ƒ**: Three.js + React Three Fiberã«ã‚ˆã‚‹æ²¡å…¥å‹3Dç’°å¢ƒ
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆ**: æ—¥æœ¬æ™‚é–“ï¼ˆUTC+9ï¼‰ã¨é€£å‹•ã—ãŸæ˜¼å¤œã‚µã‚¤ã‚¯ãƒ«
- **å‹•çš„ç…§æ˜**: å®Ÿæ™‚é–“ã«å¿œã˜ãŸå¤ªé™½ã®ä½ç½®ã¨ç…§æ˜å¤‰åŒ–
- **å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ**:
  - **æ˜¥**: æ¡œã®èŠ±ã³ã‚‰
  - **å¤**: é™½ç‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€å¼·ã„æ—¥å·®ã—
  - **ç§‹**: ç´…è‘‰ã®è½ã¡è‘‰ï¼ˆ7è‰²ï¼‰
  - **å†¬**: é›ªã€å†·ãŸã„ç…§æ˜
- **ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ **:
  - æ°´é¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  - æ—¥æ™‚è¨ˆï¼ˆå½±ã®å‹•ãï¼‰
  - æ¼‚æµã™ã‚‹ç“¶ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å­£ç¯€Ã—æ™‚é–“å¸¯ã®ä¾¿ç®‹è¡¨ç¤ºï¼‰
  - é¢¨å‘ãã‚³ãƒ³ãƒ‘ã‚¹
- **AIç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: Google Gemini APIã«ã‚ˆã‚‹1æ—¥1å›ã®æ—¥ä»˜é–¢é€£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
- **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³**: PC/ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React 19 + TypeScript
- **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Vite 7
- **3Dæç”»**: Three.js + @react-three/fiber + @react-three/drei
- **ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³**: @react-three/rapier
- **AI**: Google Gemini 2.0 Flash (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ)
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: Cloudflare Pages
- **ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹**: Cloudflare Functions
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Cloudflare R2

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³:
   ```bash
   git clone git@github.com:andsaki/biotope.git
   cd biotope-project
   ```

2. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
   ```bash
   npm install
   ```

3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•:
   ```bash
   npm run dev
   ```

4. ãƒ“ãƒ«ãƒ‰:
   ```bash
   npm run build
   ```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
src/
â”œâ”€â”€ components/              # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ DriftingBottle/
â”‚   â”‚   â”œâ”€â”€ index.tsx            # æ¼‚æµç“¶ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ BottleModel.tsx      # ç“¶ã®3Dãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â””â”€â”€ MessageCard.tsx      # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆAIç”Ÿæˆå¯¾å¿œï¼‰
â”‚   â”œâ”€â”€ FishManager.tsx          # é­šã®ç®¡ç†
â”‚   â”œâ”€â”€ Ground.tsx               # åœ°é¢
â”‚   â”œâ”€â”€ WaterSurface.tsx         # æ°´é¢
â”‚   â”œâ”€â”€ SeasonalEffects.tsx      # å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆçµ±åˆ
â”‚   â”œâ”€â”€ Sun.tsx                  # å¤ªé™½
â”‚   â”œâ”€â”€ SceneLights.tsx          # ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
â”‚   â”œâ”€â”€ Clock.tsx                # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆè¡¨ç¤º
â”‚   â””â”€â”€ UI.tsx                   # ãƒ¡ã‚¤ãƒ³UI
â”œâ”€â”€ hooks/                   # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useRealTime.ts           # æ—¥æœ¬æ™‚é–“ç®¡ç†
â”‚   â”œâ”€â”€ useWindDirection.ts      # é¢¨å‘ãç®¡ç†
â”‚   â”œâ”€â”€ useLoader.ts             # ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç®¡ç†
â”‚   â””â”€â”€ useBottleAnimation.ts    # ç“¶ã®æ¼‚æµã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ contexts/                # çŠ¶æ…‹ç®¡ç†
â”‚   â”œâ”€â”€ SeasonContext.tsx        # å­£ç¯€ç®¡ç†ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®šå¯¾å¿œï¼‰
â”‚   â””â”€â”€ TimeContext.tsx          # æ™‚é–“æƒ…å ±å…±æœ‰
â”œâ”€â”€ utils/                   # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â”‚   â”œâ”€â”€ sunPosition.ts           # å¤ªé™½ä½ç½®è¨ˆç®—
â”‚   â”œâ”€â”€ time.ts                  # æ™‚é–“å¸¯åˆ¤å®š
â”‚   â”œâ”€â”€ random.ts                # ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
â”‚   â””â”€â”€ messageUtils.ts          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ constants/               # å®šæ•°ãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ bottleMessages.ts        # å­£ç¯€Ã—æ™‚é–“å¸¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é›†
â”œâ”€â”€ constants.ts             # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®šæ•°
â””â”€â”€ assets/                  # é™çš„è³‡ç”£ï¼ˆR2ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ï¼‰

functions/
â””â”€â”€ api/
    â””â”€â”€ daily-message.ts     # Cloudflare Functions - AIæ—¥æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”ŸæˆAPI
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚³ãƒ¼ãƒ‰åˆ†å‰²
`React.lazy` ã¨ `Suspense` ã§é‡ã„3Dã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é…å»¶èª­ã¿è¾¼ã¿ã€‚

### React.memo
ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²æ­¢ã€‚

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åŠ¹ç‡åŒ–
- **FishManager**: refãƒ™ãƒ¼ã‚¹ã®æ™‚é–“ç®¡ç†ã§è¨ˆç®—å‰Šæ¸›
- **ParticleLayer**: æ›´æ–°é »åº¦ã‚’50%å‰Šæ¸›ï¼ˆ2ãƒ•ãƒ¬ãƒ¼ãƒ ã«1å›ï¼‰

### Viteãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
```ts
// vite.config.ts
export default defineConfig({
  build: {
    minify: 'esbuild',
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom'],
          'three-vendor': ['three', '@react-three/fiber', '@react-three/drei', '@react-three/rapier'],
        },
      },
    },
  },
});
```

## CI/CD

### GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

1. **upload-to-r2.yml**: ã‚¢ã‚»ãƒƒãƒˆã‚’Cloudflare R2ã«è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   - ã‚¢ã‚»ãƒƒãƒˆå¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œï¼ˆpathsæŒ‡å®šï¼‰
   - npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§Wranglerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é«˜é€ŸåŒ–
   - ä¸¦åˆ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§10ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚å‡¦ç†
   - Actions v4ã§é«˜é€ŸåŒ–

2. **cache-warm.yml**: æ¯æ—¥15:00 JSTã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒ 

### ãƒ‡ãƒ—ãƒ­ã‚¤
Cloudflare Pagesã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚ã‚¢ã‚»ãƒƒãƒˆã¯R2ã‹ã‚‰é…ä¿¡ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```mermaid
graph TB
    User[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    Browser[ãƒ–ãƒ©ã‚¦ã‚¶]
    CFPages[Cloudflare Pages]
    CFFunctions[Cloudflare Functions]
    R2[Cloudflare R2]
    Gemini[Google Gemini API]

    User -->|ã‚¢ã‚¯ã‚»ã‚¹| Browser
    Browser -->|HTMLãƒªã‚¯ã‚¨ã‚¹ãƒˆ| CFPages
    CFPages -->|HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹| Browser
    Browser -->|é™çš„ã‚¢ã‚»ãƒƒãƒˆ| R2
    R2 -->|ç”»åƒ/éŸ³å£°| Browser
    Browser -->|ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸API| CFFunctions
    CFFunctions -->|æ—¥ä»˜æƒ…å ±| Gemini
    Gemini -->|ç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸| CFFunctions
    CFFunctions -->|JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹| Browser

    style CFPages fill:#f96,stroke:#333
    style CFFunctions fill:#69f,stroke:#333
    style R2 fill:#9f6,stroke:#333
    style Gemini fill:#ff9,stroke:#333
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant B as ãƒ–ãƒ©ã‚¦ã‚¶
    participant Edge as Cloudflare Edge
    participant CF as Cloudflare Functions
    participant G as Gemini API

    U->>B: ç“¶ã‚’ã‚¯ãƒªãƒƒã‚¯
    B->>Edge: GET /api/daily-message

    alt ã‚¨ãƒƒã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ
        Edge-->>B: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (Cache-Control: max-age=86400)
    else ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹
        Edge->>CF: ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€
        CF->>CF: æ—¥æœ¬æ™‚é–“ã®æ—¥ä»˜å–å¾—
        CF->>G: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        Note over G: "11æœˆ4æ—¥ã®å¿ƒæ¸©ã¾ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ"
        G-->>CF: ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        CF-->>Edge: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”å´ (Cache-Control: 24h)
        Edge-->>B: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”å´ + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    end

    B->>B: MessageCardã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¡¨ç¤º
    B-->>U: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼

```mermaid
graph LR
    A[App.tsx] --> B[TimeContext]
    A --> C[SeasonContext]
    B --> D[æ™‚é–“æƒ…å ±]
    C --> E[å­£ç¯€æƒ…å ±]

    D --> F[Sun]
    D --> G[SceneLights]
    D --> H[SundialGnomon]
    D --> I[Clock]

    E --> J[SeasonalEffects]
    E --> K[DriftingBottle]

    J --> L[CherryBlossoms]
    J --> M[SnowEffect]
    J --> N[FallenLeaves]
    J --> O[SummerEffects]

    K --> P[BottleModel]
    K --> Q[MessageCard]
    Q --> R[Gemini API]

    style B fill:#e1f5ff
    style C fill:#fff5e1
    style R fill:#ff9
```

## AIæ©Ÿèƒ½ã®è©³ç´°

### Gemini APIçµ±åˆ

`functions/api/daily-message.ts` ã§Cloudflare Functionsã‚’ä½¿ç”¨ã—ã€æ¯æ—¥æ—¥æœ¬æ™‚é–“ã®æ—¥ä»˜ã«å¿œã˜ãŸå¿ƒæ¸©ã¾ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã€‚

**ç‰¹å¾´**:
- **ãƒ¢ãƒ‡ãƒ«**: Gemini 2.0 Flash (é«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆ)
- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: 200æ–‡å­—ä»¥å†…ã€å­£ç¯€æ„Ÿã®ã‚ã‚‹å‰å‘ããªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: 1æ—¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ç„¡é§„ãªAPIå‘¼ã³å‡ºã—ã‚’å‰Šæ¸›
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ç”Ÿæˆå¤±æ•—æ™‚ã¯æ—¢å­˜ã®å­£ç¯€Ã—æ™‚é–“å¸¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**APIä»•æ§˜**:
```
GET /api/daily-message

Response:
{
  "date": "2025-11-04",
  "dateDescription": "11æœˆ4æ—¥ï¼ˆç«æ›œæ—¥ï¼‰",
  "message": "éœœæœˆã®é¢¨ã«ã€å¿ƒã‚‚æ–°ã—ã...",
  "generatedAt": "2025-11-04T15:00:00.000Z"
}
```

### ç’°å¢ƒå¤‰æ•°è¨­å®š

Cloudflare Pagesã®ç’°å¢ƒå¤‰æ•°ã§è¨­å®š:
```
GEMINI_API_KEY=your_api_key_here
```

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [`docs/drifting-bottle-feature.md`](docs/drifting-bottle-feature.md): æ¼‚æµã™ã‚‹ç“¶ã®æ©Ÿèƒ½èª¬æ˜
- [`docs/realtime-clock-feature.md`](docs/realtime-clock-feature.md): ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆã®æ©Ÿèƒ½èª¬æ˜
- [`docs/seasonal-effects-feature.md`](docs/seasonal-effects-feature.md): å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æ©Ÿèƒ½èª¬æ˜
- [`docs/refactoring-summary.md`](docs/refactoring-summary.md): ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¦‚è¦

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT
