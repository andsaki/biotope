# æ°´è¾ºã®å››å­£ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜
React + TypeScript + Three.jsã‚’ä½¿ç”¨ã—ãŸãƒ“ã‚ªãƒˆãƒ¼ãƒ—ç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
æ—¥æœ¬æ™‚é–“ã¨é€£å‹•ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æ˜¼å¤œã‚µã‚¤ã‚¯ãƒ«ã€å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€AIç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã‚’æŒã¤ã€‚

ğŸŒ **Live Demo**: https://biotope.pages.dev/

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **React 19** + **TypeScript**
- **Vite 7** (ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«)
- **Three.js** + **@react-three/fiber** + **@react-three/drei** (3Dæç”»)
- **@react-three/rapier** (ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³)

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/ã‚¤ãƒ³ãƒ•ãƒ©
- **Cloudflare Pages** (ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°)
- **Cloudflare Functions** (ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ - Workersãƒ™ãƒ¼ã‚¹ã€NOT AWS Lambda)
- **Cloudflare R2** (é™çš„ã‚¢ã‚»ãƒƒãƒˆé…ä¿¡)
- **Google Gemini 2.0 Flash** (AI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ)

## ä¸»ãªæ©Ÿèƒ½

### 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆã‚·ã‚¹ãƒ†ãƒ 
- æ—¥æœ¬æ™‚é–“ï¼ˆUTC+9ï¼‰ã«é€£å‹•
- æ˜¼å¤œã‚µã‚¤ã‚¯ãƒ«ï¼ˆmorning/afternoon/evening/nightï¼‰
- å¤ªé™½ã®ä½ç½®è¨ˆç®—ï¼ˆå®Ÿæ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
- å‹•çš„ãªç…§æ˜å¤‰åŒ–

### 2. å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
- **æ˜¥**: æ¡œã®èŠ±ã³ã‚‰
- **å¤**: é™½ç‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€å¼·ã„æ—¥å·®ã—
- **ç§‹**: ç´…è‘‰ã®è½ã¡è‘‰ï¼ˆ7è‰²ï¼‰
- **å†¬**: é›ªã€å†·ãŸã„ç…§æ˜

### 3. AIç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ¼‚æµã™ã‚‹ç“¶ï¼‰
- **API**: `GET /api/daily-message`
- **å®Ÿè£…**: `functions/api/daily-message.ts` (Cloudflare Functions)
- **ãƒ¢ãƒ‡ãƒ«**: Gemini 2.0 Flash
- **ç”Ÿæˆå†…å®¹**: 200æ–‡å­—ä»¥å†…ã€å­£ç¯€æ„Ÿã®ã‚ã‚‹å¿ƒæ¸©ã¾ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: 24æ™‚é–“ (Cloudflare Edgeã‚­ãƒ£ãƒƒã‚·ãƒ¥)
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: `src/constants/bottleMessages.ts` ã®é™çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### 4. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ 
- æ°´é¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- æ—¥æ™‚è¨ˆï¼ˆå½±ã®å‹•ãï¼‰
- é¢¨å‘ãã‚³ãƒ³ãƒ‘ã‚¹
- æ¼‚æµã™ã‚‹ç“¶ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼‰

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
src/
â”œâ”€â”€ components/              # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ DriftingBottle/      # æ¼‚æµã™ã‚‹ç“¶æ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”œâ”€â”€ BottleModel.tsx
â”‚   â”‚   â””â”€â”€ MessageCard.tsx  # AIç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
â”‚   â”œâ”€â”€ SeasonalEffects.tsx  # å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆçµ±åˆ
â”‚   â”œâ”€â”€ SceneLights.tsx      # ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°åˆ¶å¾¡
â”‚   â”œâ”€â”€ Sun.tsx              # å¤ªé™½
â”‚   â”œâ”€â”€ Clock.tsx            # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆ
â”‚   â””â”€â”€ UI.tsx               # ãƒ¡ã‚¤ãƒ³UI
â”œâ”€â”€ contexts/                # Context API
â”‚   â”œâ”€â”€ TimeContext.tsx      # æ™‚é–“æƒ…å ±å…±æœ‰
â”‚   â””â”€â”€ SeasonContext.tsx    # å­£ç¯€æƒ…å ±å…±æœ‰
â”œâ”€â”€ hooks/                   # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useRealTime.ts       # æ—¥æœ¬æ™‚é–“ç®¡ç†
â”‚   â”œâ”€â”€ useWindDirection.ts  # é¢¨å‘ãç®¡ç†
â”‚   â””â”€â”€ useBottleAnimation.ts
â”œâ”€â”€ utils/                   # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ sunPosition.ts       # å¤ªé™½ä½ç½®è¨ˆç®—
â”‚   â”œâ”€â”€ time.ts              # æ™‚é–“å¸¯åˆ¤å®š
â”‚   â””â”€â”€ messageUtils.ts      # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
â”œâ”€â”€ constants/               # å®šæ•°
â”‚   â””â”€â”€ bottleMessages.ts    # é™çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
â””â”€â”€ assets/                  # é™çš„ã‚¢ã‚»ãƒƒãƒˆï¼ˆR2é…ä¿¡ï¼‰

functions/
â””â”€â”€ api/
    â””â”€â”€ daily-message.ts     # AI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”ŸæˆAPI
```

## é‡è¦ãªè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### ContextçµŒç”±ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
```
App.tsx
  â”œâ”€ TimeContext (æ™‚é–“æƒ…å ±)
  â”‚   â”œâ”€ Sun
  â”‚   â”œâ”€ SceneLights
  â”‚   â”œâ”€ SundialGnomon
  â”‚   â””â”€ Clock
  â””â”€ SeasonContext (å­£ç¯€æƒ…å ±)
      â”œâ”€ SeasonalEffects
      â”‚   â”œâ”€ CherryBlossoms
      â”‚   â”œâ”€ SnowEffect
      â”‚   â”œâ”€ FallenLeaves
      â”‚   â””â”€ SummerEffects
      â””â”€ DriftingBottle
```

### AI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆãƒ•ãƒ­ãƒ¼
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç“¶ã‚’ã‚¯ãƒªãƒƒã‚¯
  â†“
ãƒ–ãƒ©ã‚¦ã‚¶ â†’ Cloudflare Edge
  â†“
ã‚¨ãƒƒã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼Ÿ
  YES â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¿”å´ (Cache-Control: max-age=86400)
  NO  â†’ Cloudflare Functions â†’ Gemini API
         â†“
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ (200æ–‡å­—ä»¥å†…)
         â†“
        Edgeã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã«è¿”å´
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚³ãƒ¼ãƒ‰åˆ†å‰²
- `React.lazy` + `Suspense` ã§3Dã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é…å»¶èª­ã¿è¾¼ã¿

### 2. ãƒ¡ãƒ¢åŒ–
- ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ `React.memo` ã§ãƒ©ãƒƒãƒ—

### 3. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åŠ¹ç‡åŒ–
- FishManager: refãƒ™ãƒ¼ã‚¹ã®æ™‚é–“ç®¡ç†
- ParticleLayer: æ›´æ–°é »åº¦ã‚’50%å‰Šæ¸›ï¼ˆ2ãƒ•ãƒ¬ãƒ¼ãƒ ã«1å›ï¼‰

### 4. Viteãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
```ts
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        'react-vendor': ['react', 'react-dom'],
        'three-vendor': ['three', '@react-three/fiber', '@react-three/drei', '@react-three/rapier'],
      },
    },
  },
}
```

## CI/CD

### GitHub Actions
1. **upload-to-r2.yml**: ã‚¢ã‚»ãƒƒãƒˆã‚’R2ã«è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. **cache-warm.yml**: æ¯æ—¥15:00 JSTã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒ 

### ãƒ‡ãƒ—ãƒ­ã‚¤
- Cloudflare Pagesã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- ã‚¢ã‚»ãƒƒãƒˆã¯R2ã‹ã‚‰é…ä¿¡
- Functions ã¯è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹

## ç’°å¢ƒå¤‰æ•°

Cloudflare Pagesè¨­å®š:
```
GEMINI_API_KEY=your_api_key_here
```

## é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev

# Cloudflare Pagesé–‹ç™ºç’°å¢ƒï¼ˆFunctionså«ã‚€ï¼‰
npm run dev:wrangler

# ãƒ“ãƒ«ãƒ‰
npm run build

# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
npm run preview
```

## é‡è¦ãªæ³¨æ„ç‚¹

### Cloudflare Functions (NOT Lambda)
- `functions/api/daily-message.ts` ã® `onRequest` ãŒã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- Cloudflare Workersãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹
- ã‚¨ãƒƒã‚¸ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
- ç’°å¢ƒå¤‰æ•°ã¯ `context.env` ã‹ã‚‰å–å¾—

### AIç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: 200æ–‡å­—ä»¥å†…ã€å­£ç¯€æ„Ÿã®ã‚ã‚‹å‰å‘ããªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- maxOutputTokens: 300
- temperature: 0.9
- 1æ—¥1å›ç”Ÿæˆã€24æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- å¤±æ•—æ™‚ã¯ `bottleMessages.ts` ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

### é™çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `src/constants/bottleMessages.ts` ã¯**å‰Šé™¤ã—ãªã„**
- APIéšœå®³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ©Ÿèƒ½
- å­£ç¯€Ã—æ™‚é–“å¸¯ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¿æŒ

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/drifting-bottle-feature.md`: æ¼‚æµã™ã‚‹ç“¶ã®æ©Ÿèƒ½èª¬æ˜
- `docs/realtime-clock-feature.md`: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆã®æ©Ÿèƒ½èª¬æ˜
- `docs/seasonal-effects-feature.md`: å­£ç¯€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æ©Ÿèƒ½èª¬æ˜
- `docs/refactoring-summary.md`: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¦‚è¦

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
MIT
